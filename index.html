<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PaintStudio</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Space+Mono:wght@400;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f12;
    --panel: #1a1a22;
    --panel2: #22222e;
    --border: #2e2e3e;
    --accent: #7c6aff;
    --accent2: #ff6a9b;
    --text: #e0dff8;
    --text2: #8888aa;
    --tool-size: 44px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  /* Header */
  header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
    z-index: 10;
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 18px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .header-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
  }

  .btn {
    background: var(--panel2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'Noto Sans JP', sans-serif;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn.primary:hover { background: #9b8bff; }
  .btn.danger:hover { background: #ff4466; border-color: #ff4466; }

  /* Main layout */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Left toolbar */
  .toolbar {
    width: 60px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 4px;
    flex-shrink: 0;
    overflow-y: auto;
  }

  .tool-btn {
    width: var(--tool-size);
    height: var(--tool-size);
    border-radius: 10px;
    border: 2px solid transparent;
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    transition: all 0.15s;
    font-size: 10px;
  }
  .tool-btn svg { width: 20px; height: 20px; }
  .tool-btn:hover { background: var(--panel2); color: var(--text); }
  .tool-btn.active { background: rgba(124,106,255,0.2); border-color: var(--accent); color: var(--accent); }

  .tool-sep { width: 32px; height: 1px; background: var(--border); margin: 4px 0; }

  /* Canvas area */
  .canvas-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: 
      radial-gradient(circle at 30% 20%, rgba(124,106,255,0.05) 0%, transparent 50%),
      repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(255,255,255,0.03) 20px),
      repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(255,255,255,0.03) 20px),
      #0a0a10;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #canvas {
    background: #fff;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 20px 60px rgba(0,0,0,0.5);
    cursor: crosshair;
    touch-action: none;
    border-radius: 2px;
  }

  .zoom-info {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(26,26,34,0.9);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    color: var(--text2);
    font-family: 'Space Mono', monospace;
    pointer-events: none;
  }

  /* Right panel */
  .right-panel {
    width: 220px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }

  .panel-section {
    border-bottom: 1px solid var(--border);
    padding: 12px;
  }

  .panel-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 10px;
    font-family: 'Space Mono', monospace;
  }

  /* Color picker */
  .color-main {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }

  .color-swatch {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: transform 0.1s;
    flex-shrink: 0;
  }
  .color-swatch:hover { transform: scale(1.05); }

  .color-inputs { flex: 1; }

  .color-hex {
    width: 100%;
    background: var(--panel2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .color-hex:focus { outline: none; border-color: var(--accent); }

  #colorPicker {
    width: 100%;
    height: 28px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: none;
    padding: 0;
  }
  #colorPicker::-webkit-color-swatch-wrapper { padding: 0; border-radius: 6px; }
  #colorPicker::-webkit-color-swatch { border: 1px solid var(--border); border-radius: 6px; }

  .palette {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
    margin-top: 8px;
  }

  .pal-color {
    aspect-ratio: 1;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.1s, box-shadow 0.1s;
  }
  .pal-color:hover { transform: scale(1.2); box-shadow: 0 0 6px rgba(255,255,255,0.3); }

  /* Slider */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .slider-label {
    font-size: 11px;
    color: var(--text2);
    width: 50px;
    flex-shrink: 0;
  }

  input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: transform 0.1s;
  }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }

  .slider-val {
    font-size: 11px;
    color: var(--text);
    width: 28px;
    text-align: right;
    font-family: 'Space Mono', monospace;
    flex-shrink: 0;
  }

  /* Brush preview */
  .brush-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 50px;
    background: var(--panel2);
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: 10px;
    overflow: hidden;
  }

  #brushPreviewCanvas {
    border-radius: 4px;
  }

  /* Opacity */
  .opacity-row { margin-bottom: 0; }

  /* Blend mode */
  select {
    width: 100%;
    background: var(--panel2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
  }
  select:focus { outline: none; border-color: var(--accent); }

  /* Canvas size */
  .size-inputs {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .size-input {
    flex: 1;
    background: var(--panel2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    text-align: center;
  }
  .size-input:focus { outline: none; border-color: var(--accent); }

  .size-x { color: var(--text2); font-size: 12px; }

  /* Bottom toolbar (mobile-friendly) */
  .bottom-bar {
    display: none;
    background: var(--panel);
    border-top: 1px solid var(--border);
    padding: 8px;
    gap: 8px;
    flex-shrink: 0;
    justify-content: center;
  }

  /* Cursor crosshair circle */
  .cursor-circle {
    position: absolute;
    border-radius: 50%;
    border: 1.5px solid rgba(255,255,255,0.8);
    pointer-events: none;
    mix-blend-mode: difference;
    transform: translate(-50%, -50%);
    display: none;
    z-index: 100;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--accent);
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    pointer-events: none;
    z-index: 1000;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  @media (max-width: 700px) {
    .toolbar { width: 50px; }
    .right-panel { display: none; }
    .bottom-bar { display: flex; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">‚ú¶ PaintStudio</div>
  <div class="header-actions">
    <button class="btn danger" onclick="clearCanvas()">üóë „ÇØ„É™„Ç¢</button>
    <button class="btn" onclick="undoCanvas()">‚Ü© ÂÖÉ„Å´Êàª„Åô</button>
    <button class="btn primary" onclick="saveImage()">üíæ ‰øùÂ≠ò</button>
  </div>
</header>

<div class="app-body">
  <!-- Left Toolbar -->
  <div class="toolbar">
    <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')" title="„Éö„É≥">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm17.71-10.21a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      „Éö„É≥
    </button>
    <button class="tool-btn" id="tool-brush" onclick="setTool('brush')" title="„Éñ„É©„Ç∑">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34a1 1 0 0 0-1.41 0L9 12.25 11.75 15l8.96-8.96a1 1 0 0 0 0-1.41z"/></svg>
      „Éñ„É©„Ç∑
    </button>
    <button class="tool-btn" id="tool-pencil" onclick="setTool('pencil')" title="ÈâõÁ≠Ü">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>
      ÈâõÁ≠Ü
    </button>
    <button class="tool-btn" id="tool-watercolor" onclick="setTool('watercolor')" title="Ê∞¥ÂΩ©">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
      Ê∞¥ÂΩ©
    </button>
    <div class="tool-sep"></div>
    <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')" title="Ê∂à„Åó„Ç¥„É†">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.79.78-.79 2.04 0 2.83L5.03 20H20v-2h-5.93l8.44-8.44c.79-.79.79-2.05 0-2.84l-5.96-5.13A1.97 1.97 0 0 0 15.14 3zm.42 2.12l5.16 5.17-7.35 7.35-4.6-4.6 6.79-7.92z"/></svg>
      Ê∂à„Åó„Ç¥„É†
    </button>
    <button class="tool-btn" id="tool-fill" onclick="setTool('fill')" title="Â°ó„Çä„Å§„Å∂„Åó">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15a1.49 1.49 0 0 0 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/><path d="M0 20h24v4H0z"/></svg>
      Â°óÊΩ∞„Åó
    </button>
    <button class="tool-btn" id="tool-eyedropper" onclick="setTool('eyedropper')" title="„Çπ„Éù„Ç§„Éà">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71 5.63l-2.34-2.34a1 1 0 0 0-1.41 0l-3.12 3.12-1.41-1.42-1.42 1.42 1.41 1.41-6.6 6.6A2 2 0 0 0 5 16v3h3a2 2 0 0 0 1.42-.59l6.6-6.6 1.41 1.42 1.42-1.42-1.42-1.41 3.12-3.12a1 1 0 0 0 .16-1.65zM7 17v-1.46l5.99-5.99L14.45 11 8.46 17H7z"/></svg>
      „Çπ„Éù„Ç§„Éà
    </button>
    <div class="tool-sep"></div>
    <button class="tool-btn" id="tool-line" onclick="setTool('line')" title="Áõ¥Á∑ö">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
      Áõ¥Á∑ö
    </button>
    <button class="tool-btn" id="tool-rect" onclick="setTool('rect')" title="ÂõõËßíÂΩ¢">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm0 16H5V5h14v14z"/></svg>
      ÂõõËßí
    </button>
    <button class="tool-btn" id="tool-circle" onclick="setTool('circle')" title="ÂÜÜ">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>
      ÂÜÜ
    </button>
  </div>

  <!-- Canvas Area -->
  <div class="canvas-area" id="canvasArea">
    <div class="cursor-circle" id="cursorCircle"></div>
    <canvas id="canvas"></canvas>
    <div class="zoom-info" id="zoomInfo">100%</div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <!-- Color -->
    <div class="panel-section">
      <div class="panel-title">„Ç´„É©„Éº</div>
      <div class="color-main">
        <div class="color-swatch" id="colorSwatch" style="background:#000000" onclick="document.getElementById('colorPicker').click()"></div>
        <div class="color-inputs">
          <input type="text" class="color-hex" id="hexInput" value="#000000" maxlength="7" oninput="onHexInput(this.value)">
          <input type="color" id="colorPicker" value="#000000" oninput="onColorPick(this.value)">
        </div>
      </div>
      <div class="palette" id="palette"></div>
    </div>

    <!-- Brush -->
    <div class="panel-section">
      <div class="panel-title">„Éñ„É©„Ç∑</div>
      <div class="brush-preview">
        <canvas id="brushPreviewCanvas" width="180" height="42"></canvas>
      </div>
      <div class="slider-row">
        <div class="slider-label">„Çµ„Ç§„Ç∫</div>
        <input type="range" id="sizeSlider" min="1" max="100" value="10" oninput="onSizeChange(this.value)">
        <div class="slider-val" id="sizeVal">10</div>
      </div>
      <div class="slider-row opacity-row">
        <div class="slider-label">‰∏çÈÄèÊòéÂ∫¶</div>
        <input type="range" id="opacitySlider" min="1" max="100" value="100" oninput="onOpacityChange(this.value)">
        <div class="slider-val" id="opacityVal">100</div>
      </div>
    </div>

    <!-- Blend Mode -->
    <div class="panel-section">
      <div class="panel-title">ÂêàÊàê„É¢„Éº„Éâ</div>
      <select id="blendMode" onchange="onBlendChange(this.value)">
        <option value="source-over">ÈÄöÂ∏∏</option>
        <option value="multiply">‰πóÁÆó</option>
        <option value="screen">„Çπ„ÇØ„É™„Éº„É≥</option>
        <option value="overlay">„Ç™„Éº„Éê„Éº„É¨„Ç§</option>
        <option value="darken">Êöó„Åè</option>
        <option value="lighten">Êòé„Çã„Åè</option>
        <option value="color-dodge">Ë¶Ü„ÅÑÁÑº„Åç</option>
        <option value="color-burn">ÁÑº„ÅçËæº„Åø</option>
        <option value="hard-light">„Éè„Éº„Éâ„É©„Ç§„Éà</option>
        <option value="soft-light">„ÇΩ„Éï„Éà„É©„Ç§„Éà</option>
        <option value="difference">Â∑Æ„ÅÆÁµ∂ÂØæÂÄ§</option>
        <option value="exclusion">Èô§Â§ñ</option>
      </select>
    </div>

    <!-- Canvas Size -->
    <div class="panel-section">
      <div class="panel-title">„Ç≠„É£„É≥„Éê„Çπ</div>
      <div class="size-inputs">
        <input type="number" class="size-input" id="canvasW" value="800" min="100" max="4000">
        <span class="size-x">√ó</span>
        <input type="number" class="size-input" id="canvasH" value="600" min="100" max="4000">
      </div>
      <button class="btn" style="width:100%;margin-top:8px;justify-content:center" onclick="resizeCanvas()">ÈÅ©Áî®</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const cursorCircle = document.getElementById('cursorCircle');
const canvasArea = document.getElementById('canvasArea');

let currentTool = 'pen';
let currentColor = '#000000';
let brushSize = 10;
let brushOpacity = 1.0;
let blendMode = 'source-over';
let isDrawing = false;
let lastX = 0, lastY = 0;
let startX = 0, startY = 0;
let undoStack = [];
let MAX_UNDO = 20;
let snapshotBeforeDraw = null;
let zoom = 1.0;

// Init canvas
function initCanvas(w, h) {
  const imageData = canvas.width > 0 ? ctx.getImageData(0, 0, canvas.width, canvas.height) : null;
  canvas.width = w;
  canvas.height = h;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, w, h);
  if (imageData) ctx.putImageData(imageData, 0, 0);
  fitCanvasToArea();
}

function fitCanvasToArea() {
  const area = canvasArea.getBoundingClientRect();
  const maxW = area.width - 40;
  const maxH = area.height - 40;
  const scaleW = maxW / canvas.width;
  const scaleH = maxH / canvas.height;
  zoom = Math.min(scaleW, scaleH, 1.0);
  canvas.style.width = (canvas.width * zoom) + 'px';
  canvas.style.height = (canvas.height * zoom) + 'px';
  document.getElementById('zoomInfo').textContent = Math.round(zoom * 100) + '%';
}

initCanvas(800, 600);

// Palette colors
const paletteColors = [
  '#000000','#ffffff','#808080','#c0c0c0',
  '#ff0000','#ff4500','#ff8c00','#ffd700',
  '#adff2f','#00ff00','#00fa9a','#00ffff',
  '#0080ff','#0000ff','#8b00ff','#ff00ff',
  '#ff69b4','#deb887','#8b4513','#2f4f4f',
  '#ffe4e1','#f0e68c','#e6e6fa','#b0e0e6',
];
const palette = document.getElementById('palette');
paletteColors.forEach(c => {
  const d = document.createElement('div');
  d.className = 'pal-color';
  d.style.background = c;
  d.title = c;
  d.onclick = () => setColor(c);
  palette.appendChild(d);
});

function setColor(c) {
  currentColor = c;
  document.getElementById('colorSwatch').style.background = c;
  document.getElementById('hexInput').value = c.toUpperCase();
  document.getElementById('colorPicker').value = c;
  updateBrushPreview();
}

function onColorPick(v) { setColor(v); }

function onHexInput(v) {
  if (/^#[0-9a-fA-F]{6}$/.test(v)) {
    setColor(v);
  }
}

function onSizeChange(v) {
  brushSize = parseInt(v);
  document.getElementById('sizeVal').textContent = v;
  updateBrushPreview();
  updateCursorCircle();
}

function onOpacityChange(v) {
  brushOpacity = parseInt(v) / 100;
  document.getElementById('opacityVal').textContent = v;
  updateBrushPreview();
}

function onBlendChange(v) { blendMode = v; }

function setTool(tool) {
  currentTool = tool;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tool-' + tool)?.classList.add('active');
  updateCursorCircle();
}

function updateBrushPreview() {
  const pc = document.getElementById('brushPreviewCanvas');
  const pctx = pc.getContext('2d');
  pctx.clearRect(0, 0, pc.width, pc.height);
  pctx.fillStyle = '#1a1a22';
  pctx.fillRect(0, 0, pc.width, pc.height);
  const r = Math.min(brushSize, 36) / 2;
  pctx.globalAlpha = brushOpacity;
  pctx.fillStyle = currentColor;
  pctx.beginPath();
  pctx.arc(pc.width / 2, pc.height / 2, r, 0, Math.PI * 2);
  pctx.fill();
  pctx.globalAlpha = 1;
}
updateBrushPreview();

function updateCursorCircle() {
  const d = brushSize * zoom;
  cursorCircle.style.width = d + 'px';
  cursorCircle.style.height = d + 'px';
}
updateCursorCircle();

// Canvas events
function getCanvasPos(e) {
  const rect = canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return {
    x: (clientX - rect.left) / zoom,
    y: (clientY - rect.top) / zoom,
  };
}

function saveToUndo() {
  if (undoStack.length >= MAX_UNDO) undoStack.shift();
  undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
}

function undoCanvas() {
  if (undoStack.length === 0) return;
  ctx.putImageData(undoStack.pop(), 0, 0);
}

function clearCanvas() {
  saveToUndo();
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function drawAt(x, y, px, py) {
  ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : blendMode;
  ctx.globalAlpha = brushOpacity;
  ctx.strokeStyle = currentColor;
  ctx.fillStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  if (currentTool === 'eraser') {
    ctx.strokeStyle = 'rgba(0,0,0,1)';
    ctx.globalCompositeOperation = 'destination-out';
  }

  if (currentTool === 'pen' || currentTool === 'eraser') {
    ctx.beginPath();
    ctx.moveTo(px, py);
    ctx.lineTo(x, y);
    ctx.stroke();
  } else if (currentTool === 'brush') {
    // Soft brush
    const r = brushSize / 2;
    const grad = ctx.createRadialGradient(x, y, 0, x, y, r);
    grad.addColorStop(0, currentColor);
    grad.addColorStop(1, 'transparent');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  } else if (currentTool === 'pencil') {
    ctx.globalAlpha = brushOpacity * 0.6;
    ctx.beginPath();
    ctx.moveTo(px, py);
    ctx.lineTo(x, y);
    ctx.stroke();
  } else if (currentTool === 'watercolor') {
    ctx.globalAlpha = brushOpacity * 0.08;
    for (let i = 0; i < 5; i++) {
      const jx = x + (Math.random() - 0.5) * brushSize * 0.5;
      const jy = y + (Math.random() - 0.5) * brushSize * 0.5;
      ctx.beginPath();
      ctx.arc(jx, jy, brushSize / 2 * (0.5 + Math.random() * 0.5), 0, Math.PI * 2);
      ctx.fill();
    }
  }
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'source-over';
}

function drawShape(x, y) {
  if (!snapshotBeforeDraw) return;
  ctx.putImageData(snapshotBeforeDraw, 0, 0);
  ctx.globalCompositeOperation = blendMode;
  ctx.globalAlpha = brushOpacity;
  ctx.strokeStyle = currentColor;
  ctx.fillStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = 'round';

  if (currentTool === 'line') {
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(x, y);
    ctx.stroke();
  } else if (currentTool === 'rect') {
    ctx.beginPath();
    ctx.rect(startX, startY, x - startX, y - startY);
    ctx.stroke();
  } else if (currentTool === 'circle') {
    const rx = Math.abs(x - startX) / 2;
    const ry = Math.abs(y - startY) / 2;
    const cx = startX + (x - startX) / 2;
    const cy = startY + (y - startY) / 2;
    ctx.beginPath();
    ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'source-over';
}

function floodFill(x, y, fillColorHex) {
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;
  const tw = canvas.width;
  const th = canvas.height;
  const ix = Math.floor(x), iy = Math.floor(y);
  const idx = (iy * tw + ix) * 4;

  const tr = data[idx], tg = data[idx+1], tb = data[idx+2], ta = data[idx+3];

  const fr = parseInt(fillColorHex.slice(1,3),16);
  const fg = parseInt(fillColorHex.slice(3,5),16);
  const fb = parseInt(fillColorHex.slice(5,7),16);

  if (tr === fr && tg === fg && tb === fb && ta === 255) return;

  const stack = [[ix, iy]];
  const match = (i) => data[i]===tr && data[i+1]===tg && data[i+2]===tb && data[i+3]===ta;

  while (stack.length) {
    const [cx, cy] = stack.pop();
    const ci = (cy * tw + cx) * 4;
    if (cx < 0 || cx >= tw || cy < 0 || cy >= th) continue;
    if (!match(ci)) continue;
    data[ci]=fr; data[ci+1]=fg; data[ci+2]=fb; data[ci+3]=255;
    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
  ctx.putImageData(imgData, 0, 0);
}

function pickColor(x, y) {
  const d = ctx.getImageData(Math.floor(x), Math.floor(y), 1, 1).data;
  const hex = '#' + [d[0],d[1],d[2]].map(v=>v.toString(16).padStart(2,'0')).join('');
  setColor(hex);
}

const isShapeTool = () => ['line','rect','circle'].includes(currentTool);

canvas.addEventListener('mousedown', e => {
  const {x, y} = getCanvasPos(e);
  if (currentTool === 'fill') { saveToUndo(); floodFill(x, y, currentColor); return; }
  if (currentTool === 'eyedropper') { pickColor(x, y); return; }
  saveToUndo();
  isDrawing = true;
  lastX = x; lastY = y;
  startX = x; startY = y;
  if (isShapeTool()) snapshotBeforeDraw = ctx.getImageData(0, 0, canvas.width, canvas.height);
  else drawAt(x, y, x, y);
});

canvas.addEventListener('mousemove', e => {
  const {x, y} = getCanvasPos(e);
  // Update cursor circle
  const rect = canvas.getBoundingClientRect();
  cursorCircle.style.left = (e.clientX - canvasArea.getBoundingClientRect().left) + 'px';
  cursorCircle.style.top = (e.clientY - canvasArea.getBoundingClientRect().top) + 'px';
  cursorCircle.style.display = 'block';
  if (!isDrawing) return;
  if (isShapeTool()) { drawShape(x, y); }
  else { drawAt(x, y, lastX, lastY); lastX = x; lastY = y; }
});

canvas.addEventListener('mouseup', e => {
  if (!isDrawing) return;
  isDrawing = false;
  if (isShapeTool()) snapshotBeforeDraw = null;
});

canvas.addEventListener('mouseleave', () => {
  isDrawing = false;
  cursorCircle.style.display = 'none';
});

// Touch support
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const {x, y} = getCanvasPos(e);
  if (currentTool === 'fill') { saveToUndo(); floodFill(x, y, currentColor); return; }
  if (currentTool === 'eyedropper') { pickColor(x, y); return; }
  saveToUndo();
  isDrawing = true;
  lastX = x; lastY = y;
  startX = x; startY = y;
  if (isShapeTool()) snapshotBeforeDraw = ctx.getImageData(0, 0, canvas.width, canvas.height);
  else drawAt(x, y, x, y);
}, {passive: false});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!isDrawing) return;
  const {x, y} = getCanvasPos(e);
  if (isShapeTool()) drawShape(x, y);
  else { drawAt(x, y, lastX, lastY); lastX = x; lastY = y; }
}, {passive: false});

canvas.addEventListener('touchend', () => {
  isDrawing = false;
  if (isShapeTool()) snapshotBeforeDraw = null;
});

function saveImage() {
  const link = document.createElement('a');
  link.download = 'paintstudio_' + Date.now() + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('üíæ ÁîªÂÉè„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
}

function resizeCanvas() {
  const w = parseInt(document.getElementById('canvasW').value);
  const h = parseInt(document.getElementById('canvasH').value);
  if (w < 100 || h < 100 || w > 4000 || h > 4000) return;
  saveToUndo();
  const tmp = document.createElement('canvas');
  tmp.width = canvas.width; tmp.height = canvas.height;
  tmp.getContext('2d').drawImage(canvas, 0, 0);
  canvas.width = w; canvas.height = h;
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, w, h);
  ctx.drawImage(tmp, 0, 0);
  fitCanvasToArea();
  showToast('„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'z') { e.preventDefault(); undoCanvas(); }
    if (e.key === 's') { e.preventDefault(); saveImage(); }
  }
  if (!e.ctrlKey && !e.metaKey) {
    if (e.key === 'p') setTool('pen');
    if (e.key === 'b') setTool('brush');
    if (e.key === 'e') setTool('eraser');
    if (e.key === 'f') setTool('fill');
    if (e.key === 'i') setTool('eyedropper');
    if (e.key === '[') { brushSize = Math.max(1, brushSize - 2); document.getElementById('sizeSlider').value = brushSize; onSizeChange(brushSize); }
    if (e.key === ']') { brushSize = Math.min(100, brushSize + 2); document.getElementById('sizeSlider').value = brushSize; onSizeChange(brushSize); }
  }
});

window.addEventListener('resize', fitCanvasToArea);
</script>
</body>
</html>
